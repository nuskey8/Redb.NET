name: Build Linux Native Libraries

on:
    workflow_dispatch:
    workflow_call:

jobs:
    build-linux:
        name: Build Linux (${{ matrix.arch }})
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - arch: x64
                      target: x86_64-unknown-linux-gnu
                      output: libredb.so
                      runtime: linux-x64
                    - arch: arm64
                      target: aarch64-unknown-linux-gnu
                      output: libredb.so
                      runtime: linux-arm64
                    - arch: arm
                      target: armv7-unknown-linux-gnueabihf
                      output: libredb.so
                      runtime: linux-arm

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install cross-compilation tools
              if: matrix.arch != 'x64'
              run: |
                  sudo apt-get update
                  if [ "${{ matrix.arch }}" = "arm64" ]; then
                    sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
                  elif [ "${{ matrix.arch }}" = "arm" ]; then
                    sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
                  fi

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache cargo index
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/git
                  key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache cargo build
              uses: actions/cache@v4
              with:
                  path: native/redb-ffi/target
                  key: ${{ runner.os }}-${{ matrix.arch }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

            - name: Configure linker
              if: matrix.arch != 'x64'
              run: |
                  mkdir -p .cargo
                  if [ "${{ matrix.arch }}" = "arm64" ]; then
                    cat >> .cargo/config.toml << EOF
                  [target.aarch64-unknown-linux-gnu]
                  linker = "aarch64-linux-gnu-gcc"
                  EOF
                  elif [ "${{ matrix.arch }}" = "arm" ]; then
                    cat >> .cargo/config.toml << EOF
                  [target.armv7-unknown-linux-gnueabihf]
                  linker = "arm-linux-gnueabihf-gcc"
                  EOF
                  fi
              working-directory: native/redb-ffi

            - name: Build
              working-directory: native/redb-ffi
              run: cargo build --release --target ${{ matrix.target }}

            - name: Prepare artifact
              run: |
                  mkdir -p artifacts/${{ matrix.runtime }}/native
                  cp native/redb-ffi/target/${{ matrix.target }}/release/${{ matrix.output }} artifacts/${{ matrix.runtime }}/native/

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: native-${{ matrix.runtime }}
                  path: artifacts/${{ matrix.runtime }}/native/${{ matrix.output }}
