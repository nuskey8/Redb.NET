name: Build All Native Libraries

on:
  workflow_dispatch:

jobs:
  # Call individual platform workflows
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/build-macos.yml

  build-linux:
    name: Build Linux
    uses: ./.github/workflows/build-linux.yml

  build-windows:
    name: Build Windows
    uses: ./.github/workflows/build-windows.yml

  # Combine all artifacts and commit to repository
  combine-and-commit:
    name: Combine Artifacts and Commit
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts into runtimes directory
        run: |
          # Clear existing runtime directories for linux, macos, and windows only
          rm -rf src/Redb/runtimes/linux-*/native/*
          rm -rf src/Redb/runtimes/osx-*/native/*
          rm -rf src/Redb/runtimes/win-*/native/*

          # Copy artifacts to appropriate runtime directories
          cd all-artifacts
          for dir in native-*; do
            if [ -d "$dir" ]; then
              runtime="${dir#native-}"
              
              echo "Processing $runtime..."
              mkdir -p "../src/Redb/runtimes/$runtime/native"
              
              # Rename redb.dll to libredb.dll for Windows
              if [[ "$runtime" =~ ^win- ]]; then
                for file in "$dir"/*; do
                  filename=$(basename "$file")
                  if [[ "$filename" == "redb.dll" ]]; then
                    cp -v "$file" "../src/Redb/runtimes/$runtime/native/libredb.dll"
                  else
                    cp -v "$file" "../src/Redb/runtimes/$runtime/native/"
                  fi
                done
              else
                cp -v "$dir"/* "../src/Redb/runtimes/$runtime/native/"
              fi
            fi
          done

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain src/Redb/runtimes) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add src/Redb/runtimes
          git commit -m "chore: update native libraries for all platforms [skip ci]"
          git push

      - name: Create combined artifact for download
        run: |
          mkdir -p combined-artifacts/runtimes
          cp -r src/Redb/runtimes/* combined-artifacts/runtimes/

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-libraries-all-platforms
          path: combined-artifacts/runtimes/**/*
