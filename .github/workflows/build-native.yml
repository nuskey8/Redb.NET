name: Update Native Libraries

on:
  workflow_dispatch:

jobs:
  # Call individual platform workflows
  build-macos:
    name: Build macOS
    uses: ./.github/workflows/build-macos.yml

  build-linux:
    name: Build Linux
    uses: ./.github/workflows/build-linux.yml

  build-windows:
    name: Build Windows
    uses: ./.github/workflows/build-windows.yml

  build-ios:
    name: Build iOS
    uses: ./.github/workflows/build-ios.yml

  build-android:
    name: Build Android
    uses: ./.github/workflows/build-android.yml

  # Combine all artifacts and commit to repository
  combine-and-commit:
    name: Combine Artifacts and Commit
    needs: [build-macos, build-linux, build-windows, build-ios, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts into runtimes directory
        run: |
          # Clear existing runtime directories for linux, macos, and windows only
          rm -rf src/Redb.Interop/runtimes/linux-*/native/*
          rm -rf src/Redb.Interop/runtimes/osx-*/native/*
          rm -rf src/Redb.Interop/runtimes/win-*/native/*

          # Clear Unity plugin directories
          rm -rf src/Redb.Unity/Assets/Redb/Interop/Plugins/*/redb.*

          # Copy artifacts to appropriate runtime directories
          cd all-artifacts
          for dir in native-*; do
            if [ -d "$dir" ]; then
              runtime="${dir#native-}"
              
              echo "Processing $runtime..."
              
              # Copy to Redb/runtimes for win, osx, linux
              if [[ "$runtime" =~ ^(win-|osx-|linux-) ]]; then
                mkdir -p "../src/Redb/runtimes/$runtime/native"
                cp -v "$dir"/* "../src/Redb/runtimes/$runtime/native/"
              fi

              # Copy to Unity Plugins directory (all platforms)
              case "$runtime" in
                osx-x64|osx-arm64)
                  mkdir -p "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime"
                  cp -v "$dir"/libredb.dylib "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime/" 2>/dev/null || true
                  ;;
                linux-x64|linux-arm64)
                  mkdir -p "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime"
                  cp -v "$dir"/libredb.so "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime/" 2>/dev/null || true
                  ;;
                win-x64|win-arm64)
                  mkdir -p "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime"
                  cp -v "$dir"/redb.dll "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime/redb.dll"
                  ;;
                android-arm64|android-armv7|android-x86_64)
                  mkdir -p "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime"
                  cp -v "$dir"/libredb.so "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime/" 2>/dev/null || true
                  ;;
                ios-arm64|ios-arm64-simulator|ios-x64-simulator)
                  mkdir -p "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime"
                  cp -v "$dir"/libredb.a "../src/Redb.Unity/Assets/Redb/Interop/Plugins/$runtime/" 2>/dev/null || true
                  ;;
              esac
            fi
          done

      - name: Check for changes
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain src/Redb.Interop/runtimes src/Redb.Unity/Assets/Redb/Interop/Plugins) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add src/Redb.Interop/runtimes src/Redb.Unity/Assets/Redb/Interop/Plugins
          git commit -m "chore: update native libraries for all platforms [skip ci]"
          git push

      - name: Create combined artifact for download
        run: |
          mkdir -p combined-artifacts/runtimes
          mkdir -p combined-artifacts/unity-plugins
          cp -r src/Redb.Interop/runtimes/* combined-artifacts/runtimes/
          cp -r src/Redb.Unity/Assets/Redb/Interop/Plugins/* combined-artifacts/unity-plugins/ 2>/dev/null || true

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-libraries-all-platforms
          path: |
            combined-artifacts/runtimes/**/*
            combined-artifacts/unity-plugins/**/*
